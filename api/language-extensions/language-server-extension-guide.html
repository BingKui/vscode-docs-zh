<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Language Server Extension Guide | Hello VuePress</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/vscode-doc-zh/assets/css/0.styles.0c09eec2.css" as="style"><link rel="preload" href="/vscode-doc-zh/assets/js/app.79cc50a5.js" as="script"><link rel="preload" href="/vscode-doc-zh/assets/js/2.6081b710.js" as="script"><link rel="preload" href="/vscode-doc-zh/assets/js/36.bb77a714.js" as="script"><link rel="prefetch" href="/vscode-doc-zh/assets/js/10.dcf0234a.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/11.3443e88c.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/12.33618473.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/13.f5bcdba3.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/14.069ed78b.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/15.8ad5337f.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/16.27611e97.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/17.ae2dc47b.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/18.4a6eb331.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/19.17a60d3f.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/20.7de46031.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/21.84669414.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/22.9afacd9c.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/23.f216dfdc.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/24.0cc96f6f.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/25.be98c8b0.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/26.9406d5cd.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/27.c82f8665.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/28.14ff35c2.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/29.0b9194ef.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/3.3c269ca0.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/30.6c266e85.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/31.71b1efc9.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/32.a260662e.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/33.ebd1b0e9.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/34.8c89ccc9.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/35.8c56c023.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/37.fff25a6d.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/38.c898d862.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/39.2754f4ea.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/4.8ce84c45.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/40.08340174.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/41.022c4327.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/42.a6524d2e.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/43.8f0dd455.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/44.b23d9f65.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/45.04fcf627.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/46.789e9716.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/47.33d6f209.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/48.135250ff.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/49.3d6d3bb5.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/5.62e47b4c.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/50.44990f04.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/51.6ca0374b.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/52.eb83c9e0.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/53.9a022f02.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/54.7da689eb.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/55.25e75232.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/6.83a6b4a3.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/7.eefd45de.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/8.aa200fb5.js"><link rel="prefetch" href="/vscode-doc-zh/assets/js/9.6259a5ab.js">
    <link rel="stylesheet" href="/vscode-doc-zh/assets/css/0.styles.0c09eec2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/vscode-doc-zh/" class="sidebar-link">首页</a></li><li><a href="/vscode-doc-zh/api/" class="sidebar-link">扩展 API</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="language-server-extension-guide"><a href="#language-server-extension-guide" aria-hidden="true" class="header-anchor">#</a> Language Server Extension Guide</h1> <p>As you have seen in the <a href="/api/language-extensions/programmatic-language-features">Programmatic Language Features</a> topic, it's possible to implement Language Features by directly using <code>languages.*</code> API. Language Server Extension, however, provides an alternative way of implementing such language support.</p> <p>This topic:</p> <ul><li>Explains the benefits of Language Server Extension.</li> <li>Walks you through building a Language Server using the <a href="https://github.com/Microsoft/vscode-languageserver-node" target="_blank" rel="noopener noreferrer"><code>Microsoft/vscode-languageserver-node</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> library. You can also jump directly to the code in <a href="https://github.com/Microsoft/vscode-extension-samples/tree/master/lsp-sample" target="_blank" rel="noopener noreferrer">lsp-sample<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <h2 id="why-language-server"><a href="#why-language-server" aria-hidden="true" class="header-anchor">#</a> Why Language Server?</h2> <p>Language Server is a special kind of Visual Studio Code extension that powers the editing experience for many programming languages. With Language Servers, you can implement autocomplete, error-checking (diagnostics), jump-to-definition, and many other <a href="/api/language-extensions/programmatic-language-features">language features</a> supported in VS Code.</p> <p>However, while implementing support for language features in VS Code, we found three common problems:</p> <p>First, Language Servers are usually implemented in their native programming languages, and that presents a challenge in integrating them with VS Code, which has a Node.js runtime.</p> <p>Additionally, language features can be resource intensive. For example, to correctly validate a file, Language Server needs to parse a large amount of files, build up Abstract Syntax Trees for them and perform static program analysis. Those operations could incur significant CPU and memory usage and we need to ensure that VS Code's performance remains unaffected.</p> <p>Finally, integrating multiple language toolings with multiple code editors could involve significant effort. From language toolings' perspective, they need to adapt to code editors with different APIs. From code editors' perspective, they cannot expect any uniform API from language toolings. This makes implementing language support for <code>M</code> languages in <code>N</code> code editors the work of <code>M * N</code>.</p> <p>To solve those problems, Microsoft specified <a href="https://microsoft.github.io/language-server-protocol" target="_blank" rel="noopener noreferrer">Language Server Protocol<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which standardizes the communication between language tooling and code editor. This way, Language Servers can be implemented in any language and run in their own process to avoid performance cost, as they communicate with the code editor through the Language Server Protocol. Furthermore, any LSP-compliant language toolings can integrate with multiple LSP-compliant code editors, and any LSP-compliant code editors can easily pick up multiple LSP-compliant language toolings. LSP is a win for both language tooling providers and code editor vendors!</p> <p><img src="images/language-server-extension-guide/lsp-languages-editors.png" alt="LSP Languages and Editors"></p> <p>In this guide, we will:</p> <ul><li>Explain how to build a Language Server extension in VS Code using the provided <a href="https://github.com/Microsoft/vscode-languageserver-node" target="_blank" rel="noopener noreferrer">Node SDK<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>Explain how to run, debug, log, and test the Language Server extension.</li> <li>Point you to some advanced topics on Language Servers.</li></ul> <h2 id="implementing-a-language-server"><a href="#implementing-a-language-server" aria-hidden="true" class="header-anchor">#</a> Implementing a Language Server</h2> <h3 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h3> <p>In VS Code, a language server has two parts:</p> <ul><li>Language Client: A normal VS Code extension written in JavaScript / TypeScript. This extension has access to all <a href="/api/references/vscode-api">VS Code Namespace API</a>.</li> <li>Language Server: A language analysis tool running in a separate process.</li></ul> <p>As briefly stated above there are two benefits of running the Language Server in a separate process:</p> <ul><li>The analysis tool can be implemented in any languages, as long as it can communicate with the Language Client following the Language Server Protocol.</li> <li>As language analysis tools are often heavy on CPU and Memory usage, running them in separate process avoids performance cost.</li></ul> <p>Here is an illustration of VS Code running two Language Server extensions. The HTML Language Client and PHP Language Client are normal VS Code extensions written in TypeScript. Each of them instantiates a corresponding Language Server and communicates with them through LSP. Although the PHP Language Server is written in PHP, it can still communicate with the PHP Language Client through LSP.</p> <p><img src="images/language-server-extension-guide/lsp-illustration.png" alt="LSP Illustration"></p> <p>This guide will teach you how to build a Language Client / Server using our <a href="https://github.com/Microsoft/vscode-languageserver-node" target="_blank" rel="noopener noreferrer">Node SDK<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The remaining document assumes that you are familiar with VS Code <a href="/api">Extension API</a>.</p> <h3 id="lsp-sample-a-simple-language-server-for-plain-text-files"><a href="#lsp-sample-a-simple-language-server-for-plain-text-files" aria-hidden="true" class="header-anchor">#</a> LSP Sample - A simple Language Server for plain text files</h3> <p>Let's build a simple Language Server extension that implements autocomplete and diagnostics for plain text files. We will also cover the syncing of configurations between Client / Server.</p> <p>If you prefer to jump right into the code:</p> <ul><li><strong><a href="https://github.com/Microsoft/vscode-extension-samples/tree/master/lsp-sample" target="_blank" rel="noopener noreferrer">lsp-sample<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>: Heavily documented source code for this guide.</li> <li><strong><a href="https://github.com/Microsoft/vscode-extension-samples/tree/master/lsp-multi-server-sample" target="_blank" rel="noopener noreferrer">lsp-multi-server-sample<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>: A heavily documented, advanced version of <strong>lsp-sample</strong> that starts a different server instance per workspace folder to support the <a href="/docs/editor/multi-root-workspaces">multi-root workspace</a> feature in VS Code.</li></ul> <p>Clone the repository <a href="https://github.com/Microsoft/vscode-extension-samples" target="_blank" rel="noopener noreferrer">Microsoft/vscode-extension-samples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and open the sample:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">git</span> clone https://github.com/Microsoft/vscode-extension-samples.git
<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> vscode-extension-samples/lsp-sample
<span class="token operator">&gt;</span> <span class="token function">npm</span> <span class="token function">install</span>
<span class="token operator">&gt;</span> <span class="token function">npm</span> run compile
<span class="token operator">&gt;</span> code <span class="token builtin class-name">.</span>
</code></pre></div><p>The above installs all dependencies and opens the <strong>lsp-sample</strong> workspace containing both the client and server code. Here is a rough overview of the structure of <strong>lsp-sample</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>.
├── client // Language Client
│   ├── src
│   │   ├── test // End to End tests for Language Client / Server
│   │   └── extension.ts // Language Client entry point
├── package.json // The extension manifest
└── server // Language Server
    └── src
        └── server.ts // Language Server entry point
</code></pre></div><h3 id="explaining-the-language-client"><a href="#explaining-the-language-client" aria-hidden="true" class="header-anchor">#</a> Explaining the 'Language Client'</h3> <p>Let's first take a look at <code>/package.json</code>, which describes the capabilities of the Language Client. There are three interesting sections:</p> <p>First look the <a href="/api/references/activation-events"><code>activationEvents</code></a>:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;activationEvents&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;onLanguage:plaintext&quot;</span>
<span class="token punctuation">]</span>
</code></pre></div><p>This section tells VS Code to activate the extension as soon as a plain text file is opened (for example a file with the extension <code>.txt</code>).</p> <p>Next look at the <a href="/api/references/contribution-points#contributes.configuration"><code>configuration</code></a> section:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;configuration&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Example configuration&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;languageServerExample.maxNumberOfProblems&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resource&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Controls the maximum number of problems produced by the server.&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This section contributes <code>configuration</code> settings to VS Code. The example will explain how these settings are sent over to the language server on startup and on every change of the settings.</p> <p>The actual Language Client code and the corresponding <code>package.json</code> is in the <code>/client</code> folder. The interesting part in the <code>/client/package.json</code> file is that it adds a dependency to the <code>vscode</code> extension host API and the <code>vscode-languageclient</code> library:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vscode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.18&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vscode-languageclient&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.4&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As mentioned, the client is implemented as a normal VS Code extension, and it has access to all VS Code namespace API.</p> <p>Below is the content of the corresponding extension.ts file, which is the entry of the <strong>lsp-sample</strong> extension:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> workspace<span class="token punctuation">,</span> ExtensionContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  LanguageClient<span class="token punctuation">,</span>
  LanguageClientOptions<span class="token punctuation">,</span>
  ServerOptions<span class="token punctuation">,</span>
  TransportKind
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vscode-languageclient'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> client<span class="token punctuation">:</span> LanguageClient<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">:</span> ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The server is implemented in node</span>
  <span class="token keyword">let</span> serverModule <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">asAbsolutePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token string">'out'</span><span class="token punctuation">,</span> <span class="token string">'server.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// The debug options for the server</span>
  <span class="token comment">// --inspect=6009: runs the server in Node's Inspector mode so VS Code can attach to the server for debugging</span>
  <span class="token keyword">let</span> debugOptions <span class="token operator">=</span> <span class="token punctuation">{</span> execArgv<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--nolazy'</span><span class="token punctuation">,</span> <span class="token string">'--inspect=6009'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// If the extension is launched in debug mode then the debug server options are used</span>
  <span class="token comment">// Otherwise the run options are used</span>
  <span class="token keyword">let</span> serverOptions<span class="token punctuation">:</span> ServerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    run<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">module</span><span class="token punctuation">:</span> serverModule<span class="token punctuation">,</span> transport<span class="token punctuation">:</span> TransportKind<span class="token punctuation">.</span>ipc <span class="token punctuation">}</span><span class="token punctuation">,</span>
    debug<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">module</span><span class="token punctuation">:</span> serverModule<span class="token punctuation">,</span>
      transport<span class="token punctuation">:</span> TransportKind<span class="token punctuation">.</span>ipc<span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> debugOptions
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Options to control the language client</span>
  <span class="token keyword">let</span> clientOptions<span class="token punctuation">:</span> LanguageClientOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// Register the server for plain text documents</span>
    documentSelector<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> scheme<span class="token punctuation">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span> language<span class="token punctuation">:</span> <span class="token string">'plaintext'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    synchronize<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Notify the server about file changes to '.clientrc files contained in the workspace</span>
      fileEvents<span class="token punctuation">:</span> workspace<span class="token punctuation">.</span><span class="token function">createFileSystemWatcher</span><span class="token punctuation">(</span><span class="token string">'**/.clientrc'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create the language client and start the client.</span>
  client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LanguageClient</span><span class="token punctuation">(</span>
    <span class="token string">'languageServerExample'</span><span class="token punctuation">,</span>
    <span class="token string">'Language Server Example'</span><span class="token punctuation">,</span>
    serverOptions<span class="token punctuation">,</span>
    clientOptions
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Start the client. This will also launch the server</span>
  client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deactivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Thenable<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> undefined<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="explaining-the-language-server"><a href="#explaining-the-language-server" aria-hidden="true" class="header-anchor">#</a> Explaining the 'Language Server'</h3> <blockquote><p><strong>Note:</strong> The 'Server' implementation cloned from the GitHub repository has the final walkthrough implementation. To follow the walkthrough, you can create a new <code>server.ts</code> or modify the contents of the cloned version.</p></blockquote> <p>In the example, the server is also implemented in TypeScript and executed using Node.js. Since VS Code already ships with a Node.js runtime, there is no need to provide your own, unless you have specific requirements for the runtime.</p> <p>The source code for the Language Server is at <code>/server</code>. The interesting section in the server's <code>package.json</code> file is:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vscode-languageserver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.3&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This pulls in the <code>vscode-languageserver</code> library.</p> <p>Below is a server implementation that uses the provided simple text document manager that synchronizes text documents by always sending the file's full content from VS Code to the server.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  createConnection<span class="token punctuation">,</span>
  TextDocuments<span class="token punctuation">,</span>
  TextDocument<span class="token punctuation">,</span>
  Diagnostic<span class="token punctuation">,</span>
  DiagnosticSeverity<span class="token punctuation">,</span>
  ProposedFeatures<span class="token punctuation">,</span>
  InitializeParams<span class="token punctuation">,</span>
  DidChangeConfigurationNotification<span class="token punctuation">,</span>
  CompletionItem<span class="token punctuation">,</span>
  CompletionItemKind<span class="token punctuation">,</span>
  TextDocumentPositionParams
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vscode-languageserver'</span><span class="token punctuation">;</span>

<span class="token comment">// Create a connection for the server. The connection uses Node's IPC as a transport.</span>
<span class="token comment">// Also include all preview / proposed LSP features.</span>
<span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>ProposedFeatures<span class="token punctuation">.</span>all<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a simple text document manager. The text document manager</span>
<span class="token comment">// supports full document sync only</span>
<span class="token keyword">let</span> documents<span class="token punctuation">:</span> TextDocuments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDocuments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> hasConfigurationCapability<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hasWorkspaceFolderCapability<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hasDiagnosticRelatedInformationCapability<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">:</span> InitializeParams</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> capabilities <span class="token operator">=</span> params<span class="token punctuation">.</span>capabilities<span class="token punctuation">;</span>

  <span class="token comment">// Does the client support the `workspace/configuration` request?</span>
  <span class="token comment">// If not, we will fall back using global settings</span>
  hasConfigurationCapability <span class="token operator">=</span>
    capabilities<span class="token punctuation">.</span>workspace <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>capabilities<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span>configuration<span class="token punctuation">;</span>
  hasWorkspaceFolderCapability <span class="token operator">=</span>
    capabilities<span class="token punctuation">.</span>workspace <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>capabilities<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span>workspaceFolders<span class="token punctuation">;</span>
  hasDiagnosticRelatedInformationCapability <span class="token operator">=</span>
    capabilities<span class="token punctuation">.</span>textDocument <span class="token operator">&amp;&amp;</span>
    capabilities<span class="token punctuation">.</span>textDocument<span class="token punctuation">.</span>publishDiagnostics <span class="token operator">&amp;&amp;</span>
    capabilities<span class="token punctuation">.</span>textDocument<span class="token punctuation">.</span>publishDiagnostics<span class="token punctuation">.</span>relatedInformation<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    capabilities<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      textDocumentSync<span class="token punctuation">:</span> documents<span class="token punctuation">.</span>syncKind<span class="token punctuation">,</span>
      <span class="token comment">// Tell the client that the server supports code completion</span>
      completionProvider<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        resolveProvider<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onInitialized</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasConfigurationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Register for all configuration changes.</span>
    connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>DidChangeConfigurationNotification<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">,</span> undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasWorkspaceFolderCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span><span class="token function">onDidChangeWorkspaceFolders</span><span class="token punctuation">(</span><span class="token parameter">_event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Workspace folder change event received.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The example settings</span>
<span class="token keyword">interface</span> <span class="token class-name">ExampleSettings</span> <span class="token punctuation">{</span>
  maxNumberOfProblems<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// The global settings, used when the `workspace/configuration` request is not supported by the client.</span>
<span class="token comment">// Please note that this is not the case when using this server with the client provided in this example</span>
<span class="token comment">// but could happen with other clients.</span>
<span class="token keyword">const</span> defaultSettings<span class="token punctuation">:</span> ExampleSettings <span class="token operator">=</span> <span class="token punctuation">{</span> maxNumberOfProblems<span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> globalSettings<span class="token punctuation">:</span> ExampleSettings <span class="token operator">=</span> defaultSettings<span class="token punctuation">;</span>

<span class="token comment">// Cache the settings of all open documents</span>
<span class="token keyword">let</span> documentSettings<span class="token punctuation">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Thenable<span class="token operator">&lt;</span>ExampleSettings<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onDidChangeConfiguration</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasConfigurationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reset all cached document settings</span>
    documentSettings<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    globalSettings <span class="token operator">=</span> <span class="token operator">&lt;</span>ExampleSettings<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>change<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>languageServerExample <span class="token operator">||</span> defaultSettings<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Revalidate all open text documents</span>
  documents<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>validateTextDocument<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getDocumentSettings</span><span class="token punctuation">(</span><span class="token parameter">resource<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Thenable<span class="token operator">&lt;</span>ExampleSettings<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasConfigurationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>globalSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> documentSettings<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      scopeUri<span class="token punctuation">:</span> resource<span class="token punctuation">,</span>
      section<span class="token punctuation">:</span> <span class="token string">'languageServerExample'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    documentSettings<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Only keep settings for open documents</span>
documents<span class="token punctuation">.</span><span class="token function">onDidClose</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  documentSettings<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>document<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The content of a text document has changed. This event is emitted</span>
<span class="token comment">// when the text document first opened or when its content has changed.</span>
documents<span class="token punctuation">.</span><span class="token function">onDidChangeContent</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">validateTextDocument</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateTextDocument</span><span class="token punctuation">(</span><span class="token parameter">textDocument<span class="token punctuation">:</span> TextDocument</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// In this simple example we get the settings for every validate run.</span>
  <span class="token keyword">let</span> settings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDocumentSettings</span><span class="token punctuation">(</span>textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The validator creates diagnostics for all uppercase words length 2 and more</span>
  <span class="token keyword">let</span> text <span class="token operator">=</span> textDocument<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token regex">/\b[A-Z]{2,}\b/g</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> m<span class="token punctuation">:</span> RegExpExecArray<span class="token punctuation">;</span>

  <span class="token keyword">let</span> problems <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> diagnostics<span class="token punctuation">:</span> Diagnostic<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> problems <span class="token operator">&lt;</span> settings<span class="token punctuation">.</span>maxNumberOfProblems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    problems<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diagnostic<span class="token punctuation">:</span> Diagnostic <span class="token operator">=</span> <span class="token punctuation">{</span>
      severity<span class="token punctuation">:</span> DiagnosticSeverity<span class="token punctuation">.</span>Warning<span class="token punctuation">,</span>
      range<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        start<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        end<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is all uppercase.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      source<span class="token punctuation">:</span> <span class="token string">'ex'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiagnosticRelatedInformationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      diagnostic<span class="token punctuation">.</span>relatedInformation <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
            range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'Spelling matters'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
            range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'Particularly for names'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    diagnostics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>diagnostic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Send the computed diagnostics to VS Code.</span>
  connection<span class="token punctuation">.</span><span class="token function">sendDiagnostics</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span> diagnostics <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

connection<span class="token punctuation">.</span><span class="token function">onDidChangeWatchedFiles</span><span class="token punctuation">(</span><span class="token parameter">_change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Monitored files have change in VS Code</span>
  connection<span class="token punctuation">.</span><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'We received an file change event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This handler provides the initial list of the completion items.</span>
connection<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>_textDocumentPosition<span class="token punctuation">:</span> TextDocumentPositionParams<span class="token punctuation">)</span><span class="token punctuation">:</span> CompletionItem<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The pass parameter contains the position of the text document in</span>
    <span class="token comment">// which code complete got requested. For the example we ignore this</span>
    <span class="token comment">// info and always provide the same completion items.</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token string">'TypeScript'</span><span class="token punctuation">,</span>
        kind<span class="token punctuation">:</span> CompletionItemKind<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token string">'JavaScript'</span><span class="token punctuation">,</span>
        kind<span class="token punctuation">:</span> CompletionItemKind<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This handler resolves additional information for the item selected in</span>
<span class="token comment">// the completion list.</span>
connection<span class="token punctuation">.</span><span class="token function">onCompletionResolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>item<span class="token punctuation">:</span> CompletionItem<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">CompletionItem</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>detail <span class="token operator">=</span> <span class="token string">'TypeScript details'</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>documentation <span class="token operator">=</span> <span class="token string">'TypeScript documentation'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>detail <span class="token operator">=</span> <span class="token string">'JavaScript details'</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>documentation <span class="token operator">=</span> <span class="token string">'JavaScript documentation'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> item<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
connection.onDidOpenTextDocument((params) =&gt; {
    // A text document got opened in VS Code.
    // params.uri uniquely identifies the document. For documents store on disk this is a file URI.
    // params.text the initial full content of the document.
    connection.console.log(`${params.textDocument.uri} opened.`);
});
connection.onDidChangeTextDocument((params) =&gt; {
    // The content of a text document did change in VS Code.
    // params.uri uniquely identifies the document.
    // params.contentChanges describe the content changes to the document.
    connection.console.log(`${params.textDocument.uri} changed: ${JSON.stringify(params.contentChanges)}`);
});
connection.onDidCloseTextDocument((params) =&gt; {
    // A text document got closed in VS Code.
    // params.uri uniquely identifies the document.
    connection.console.log(`${params.textDocument.uri} closed.`);
});
*/</span>

<span class="token comment">// Make the text document manager listen on the connection</span>
<span class="token comment">// for open, change and close text document events</span>
documents<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listen on the connection</span>
connection<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="adding-a-simple-validation"><a href="#adding-a-simple-validation" aria-hidden="true" class="header-anchor">#</a> Adding a Simple Validation</h3> <p>To add document validation to the server, we add a listener to the text document manager that gets called whenever the content of a text document changes. It is then up to the server to decide when the best time is to validate a document. In the example implementation, the server validates the plain text document and flags all occurrences of words that use ALL CAPS. The corresponding code snippet looks like this:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// The content of a text document has changed. This event is emitted</span>
<span class="token comment">// when the text document first opened or when its content has changed.</span>
documents<span class="token punctuation">.</span><span class="token function">onDidChangeContent</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// In this simple example we get the settings for every validate run.</span>
    <span class="token keyword">let</span> settings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDocumentSettings</span><span class="token punctuation">(</span>textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The validator creates diagnostics for all uppercase words length 2 and more</span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> textDocument<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token regex">/\b[A-Z]{2,}\b/g</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m<span class="token punctuation">:</span> RegExpExecArray<span class="token punctuation">;</span>

    <span class="token keyword">let</span> problems <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diagnostics<span class="token punctuation">:</span> Diagnostic<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        problems<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> diagnostic<span class="token punctuation">:</span> Diagnostic <span class="token operator">=</span> <span class="token punctuation">{</span>
            severity<span class="token punctuation">:</span> DiagnosticSeverity<span class="token punctuation">.</span>Warning<span class="token punctuation">,</span>
            range<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                start<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                end<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is all uppercase.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            source<span class="token punctuation">:</span> <span class="token string">'ex'</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiagnosticRelatedInformationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            diagnostic<span class="token punctuation">.</span>relatedInformation <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
                        range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    message<span class="token punctuation">:</span> <span class="token string">'Spelling matters'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
                        range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    message<span class="token punctuation">:</span> <span class="token string">'Particularly for names'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        diagnostics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>diagnostic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Send the computed diagnostics to VS Code.</span>
    connection<span class="token punctuation">.</span><span class="token function">sendDiagnostics</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span> diagnostics <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="diagnostics-tips-and-tricks"><a href="#diagnostics-tips-and-tricks" aria-hidden="true" class="header-anchor">#</a> Diagnostics Tips and Tricks</h3> <ul><li>If the start and end positions are the same, VS Code will underline with a squiggle the word at that position.</li> <li>If you want to underline with a squiggle until the end of the line, then set the character of the end position to Number.MAX_VALUE.</li></ul> <p>To run the Language Server, do the following:</p> <ul><li>press <code>kb(workbench.action.tasks.build)</code> to start the build task. The task compiles both the client and the server.</li> <li>open the debug viewlet, select the <code>Launch Client</code> launch configuration, and press the <code>Start Debugging</code> button to launch an additional <code>Extension Development Host</code> instance of VS Code that executes the extension code.</li> <li>Create a test.txt file in the root folder and paste the following content:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>TypeScript lets you <span class="token function">write</span> JavaScript the way you really want to.
TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.
ANY browser. ANY host. ANY OS. Open Source.
</code></pre></div><p>The <code>Extension Development Host</code> instance will then look like this:</p> <p><img src="images/language-server-extension-guide/validation.png" alt="Validating a text file"></p> <h3 id="debugging-both-client-and-server"><a href="#debugging-both-client-and-server" aria-hidden="true" class="header-anchor">#</a> Debugging both Client and Server</h3> <p>Debugging the client code is as easy as debugging a normal extension. Set a breakpoint in the client code and debug the extension by pressing <code>kb(workbench.action.debug.start)</code>.</p> <p><img src="images/language-server-extension-guide/debugging-client.png" alt="Debugging the client"></p> <p>Since the server is started by the <code>LanguageClient</code> running in the extension (client), we need to attach a debugger to the running server. To do so, switch to the Debug view and select the launch configuration <code>Attach to Server</code> and press <code>kb(workbench.action.debug.start)</code>. This will attach the debugger to the server.</p> <p><img src="images/language-server-extension-guide/debugging-server.png" alt="Debugging the server"></p> <h3 id="logging-support-for-language-server"><a href="#logging-support-for-language-server" aria-hidden="true" class="header-anchor">#</a> Logging Support for Language Server</h3> <p>If you are using <code>vscode-languageclient</code> to implement the client, you can specify a setting <code>[langId].trace.server</code> that instructs the Client to log communications between Language Client / Server to a channel of the Language Client's <code>name</code>.</p> <p>For <strong>lsp-sample</strong>, you can set this setting: <code>&quot;languageServerExample.trace.server&quot;: &quot;verbose&quot;</code>. Now head to the channel &quot;Language Server Example&quot;. You should see the logs:</p> <p><img src="images/language-server-extension-guide/lsp-log.png" alt="LSP Log"></p> <p>As Language Servers can be chatty (5 seconds of real-world usage can produce 5000 lines of log), we also provide a tool to visualize and filter the communication between Language Client / Server. You can save all logs from the channel into a file, and load that file with the <a href="https://github.com/Microsoft/language-server-protocol-inspector" target="_blank" rel="noopener noreferrer">Language Server Protocol Inspector<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> at <a href="https://microsoft.github.io/language-server-protocol/inspector" target="_blank" rel="noopener noreferrer">https://microsoft.github.io/language-server-protocol/inspector<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p><img src="images/language-server-extension-guide/lsp-inspector.png" alt="LSP Inspector"></p> <h3 id="using-configuration-settings-in-the-server"><a href="#using-configuration-settings-in-the-server" aria-hidden="true" class="header-anchor">#</a> Using Configuration Settings in the Server</h3> <p>When writing the client part of the extension, we already defined a setting to control the maximum numbers of problems reported. We also wrote code on the server side to read these settings from the client:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">getDocumentSettings</span><span class="token punctuation">(</span><span class="token parameter">resource<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Thenable<span class="token operator">&lt;</span>ExampleSettings<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasConfigurationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>globalSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> documentSettings<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      scopeUri<span class="token punctuation">:</span> resource<span class="token punctuation">,</span>
      section<span class="token punctuation">:</span> <span class="token string">'languageServerExample'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    documentSettings<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The only thing we need to do now is to listen to configuration changes on the server side and if a settings changes, revalidate the open text documents. To be able to reuse the validate logic of the document change event handling, we extract the code into a <code>validateTextDocument</code> function and modify the code to honor a <code>maxNumberOfProblems</code> variable:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateTextDocument</span><span class="token punctuation">(</span><span class="token parameter">textDocument<span class="token punctuation">:</span> TextDocument</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// In this simple example we get the settings for every validate run.</span>
  <span class="token keyword">let</span> settings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDocumentSettings</span><span class="token punctuation">(</span>textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The validator creates diagnostics for all uppercase words length 2 and more</span>
  <span class="token keyword">let</span> text <span class="token operator">=</span> textDocument<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token regex">/\b[A-Z]{2,}\b/g</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> m<span class="token punctuation">:</span> RegExpExecArray<span class="token punctuation">;</span>

  <span class="token keyword">let</span> problems <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> diagnostics<span class="token punctuation">:</span> Diagnostic<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> problems <span class="token operator">&lt;</span> settings<span class="token punctuation">.</span>maxNumberOfProblems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    problems<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diagnostic<span class="token punctuation">:</span> Diagnostic <span class="token operator">=</span> <span class="token punctuation">{</span>
      severity<span class="token punctuation">:</span> DiagnosticSeverity<span class="token punctuation">.</span>Warning<span class="token punctuation">,</span>
      range<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        start<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        end<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span><span class="token function">positionAt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is all uppercase.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      source<span class="token punctuation">:</span> <span class="token string">'ex'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiagnosticRelatedInformationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      diagnostic<span class="token punctuation">.</span>relatedInformation <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
            range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'Spelling matters'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          location<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
            range<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> diagnostic<span class="token punctuation">.</span>range<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'Particularly for names'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    diagnostics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>diagnostic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Send the computed diagnostics to VS Code.</span>
  connection<span class="token punctuation">.</span><span class="token function">sendDiagnostics</span><span class="token punctuation">(</span><span class="token punctuation">{</span> uri<span class="token punctuation">:</span> textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">,</span> diagnostics <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The handling of the configuration change is done by adding a notification handler for configuration changes to the connection. The corresponding code looks like this:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>connection<span class="token punctuation">.</span><span class="token function">onDidChangeConfiguration</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasConfigurationCapability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reset all cached document settings</span>
    documentSettings<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    globalSettings <span class="token operator">=</span> <span class="token operator">&lt;</span>ExampleSettings<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>change<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>languageServerExample <span class="token operator">||</span> defaultSettings<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Revalidate all open text documents</span>
  documents<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>validateTextDocument<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Starting the client again and changing the setting to maximum report 1 problem results in the following validation:</p> <p><img src="images/language-server-extension-guide/validationOneProblem.png" alt="Maximum One Problem"></p> <h3 id="adding-additional-language-features"><a href="#adding-additional-language-features" aria-hidden="true" class="header-anchor">#</a> Adding additional Language Features</h3> <p>The first interesting feature a language server usually implements is validation of documents. In that sense, even a linter counts as a language server and in VS Code linters are usually implemented as language servers (see <a href="https://github.com/Microsoft/vscode-eslint" target="_blank" rel="noopener noreferrer">eslint<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://github.com/Microsoft/vscode-jshint" target="_blank" rel="noopener noreferrer">jshint<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for examples). But there is more to language servers. They can provide code completion, Find All References, or Go To Definition. The example code below adds code completion to the server. It proposes the two words 'TypeScript' and 'JavaScript'.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// This handler provides the initial list of the completion items.</span>
connection<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>_textDocumentPosition<span class="token punctuation">:</span> TextDocumentPositionParams<span class="token punctuation">)</span><span class="token punctuation">:</span> CompletionItem<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The pass parameter contains the position of the text document in</span>
    <span class="token comment">// which code complete got requested. For the example we ignore this</span>
    <span class="token comment">// info and always provide the same completion items.</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token string">'TypeScript'</span><span class="token punctuation">,</span>
        kind<span class="token punctuation">:</span> CompletionItemKind<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token string">'JavaScript'</span><span class="token punctuation">,</span>
        kind<span class="token punctuation">:</span> CompletionItemKind<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This handler resolves additional information for the item selected in</span>
<span class="token comment">// the completion list.</span>
connection<span class="token punctuation">.</span><span class="token function">onCompletionResolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>item<span class="token punctuation">:</span> CompletionItem<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">CompletionItem</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>detail <span class="token operator">=</span> <span class="token string">'TypeScript details'</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>documentation <span class="token operator">=</span> <span class="token string">'TypeScript documentation'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>detail <span class="token operator">=</span> <span class="token string">'JavaScript details'</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>documentation <span class="token operator">=</span> <span class="token string">'JavaScript documentation'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> item<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>data</code> fields are used to uniquely identify a completion item in the resolve handler. The data property is transparent for the protocol. Since the underlying message passing protocol is JSON-based, the data field should only hold data that is serializable to and from JSON.</p> <p>All that is missing is to tell VS Code that the server supports code completion requests. To do so, flag the corresponding capability in the initialize handler:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>connection<span class="token punctuation">.</span><span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">InitializeResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        capabilities<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
            <span class="token comment">// Tell the client that the server supports code completion</span>
            completionProvider<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                resolveProvider<span class="token punctuation">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The screenshot below shows the completed code running on a plain text file:</p> <p><img src="images/language-server-extension-guide/codeComplete.png" alt="Code Complete"></p> <h3 id="testing-the-language-server"><a href="#testing-the-language-server" aria-hidden="true" class="header-anchor">#</a> Testing The Language Server</h3> <p>To create a high-quality Language Server, we need to build a good test suite covering its functionalities. There are two common ways of testing Language Servers:</p> <ul><li>Unit Test: This is useful if you want to test specific functionalities in Language Servers by mocking up all the information being sent to it. VS Code's <a href="https://github.com/Microsoft/vscode-html-languageservice" target="_blank" rel="noopener noreferrer">HTML<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> / <a href="https://github.com/Microsoft/vscode-css-languageservice" target="_blank" rel="noopener noreferrer">CSS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> / <a href="https://github.com/Microsoft/vscode-json-languageservice" target="_blank" rel="noopener noreferrer">JSON<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Language Servers take this approach to testing. The LSP npm modules itself use the approach. See <a href="https://github.com/Microsoft/vscode-languageserver-node/blob/master/protocol/src/test/connection.test.ts" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for some unit test written using the npm protocol module.</li> <li>End-to-End Test: This is similar to <a href="/api/working-with-extensions/testing-extension">VS Code extension test</a>. The benefit of this approach is that it runs the test by instantiating a VS Code instance with a workspace, opening the file, activating the Language Client / Server, and running <a href="/api/references/commands">VS Code commands</a>. This approach is superior if you have files, settings, or dependencies (such as <code>node_modules</code>) which are hard or impossible to mock. The popular <a href="https://github.com/Microsoft/vscode-python" target="_blank" rel="noopener noreferrer">Python<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> extension takes this approach to testing.</li></ul> <p>It is possible to do Unit Test in any testing framework of your choice. Here we describe how to do End-to-End testing for Language Server Extension.</p> <p>Open <code>.vscode/launch.json</code>, and you can find a <code>E2E</code> test target:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Language Server E2E Test&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;extensionHost&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${execPath}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;--extensionDevelopmentPath=${workspaceRoot}&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;--extensionTestsPath=${workspaceRoot}/client/out/test&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;${workspaceRoot}/client/testFixture&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;stopOnEntry&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sourceMaps&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outFiles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;${workspaceRoot}/client/out/test/**/*.js&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you run this debug target, it will launch a VS Code instance with <code>client/testFixture</code> as the active workspace. VS Code will then proceed to execute all tests in <code>client/src/test</code>. As a debugging tip, you can set breakpoints in TypeScript files in <code>client/src/test</code> and they will be hit.</p> <p>Let's take a look at the <code>completion.test.ts</code> file:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> assert <span class="token keyword">from</span> <span class="token string">'assert'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getDocUri<span class="token punctuation">,</span> activate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helper'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Should do completion'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> docUri <span class="token operator">=</span> <span class="token function">getDocUri</span><span class="token punctuation">(</span><span class="token string">'completion.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Completes JS/TS in txt file'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">testCompletion</span><span class="token punctuation">(</span>docUri<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">vscode<span class="token punctuation">.</span>Position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      items<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> label<span class="token punctuation">:</span> <span class="token string">'JavaScript'</span><span class="token punctuation">,</span> kind<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>CompletionItemKind<span class="token punctuation">.</span>Text <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> label<span class="token punctuation">:</span> <span class="token string">'TypeScript'</span><span class="token punctuation">,</span> kind<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>CompletionItemKind<span class="token punctuation">.</span>Text <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testCompletion</span><span class="token punctuation">(</span>
  <span class="token parameter">docUri<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>Uri<span class="token punctuation">,</span>
  position<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>Position<span class="token punctuation">,</span>
  expectedCompletionList<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>CompletionList</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">activate</span><span class="token punctuation">(</span>docUri<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Executing the command `vscode.executeCompletionItemProvider` to simulate triggering completion</span>
  <span class="token keyword">const</span> actualCompletionList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> vscode<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>
    <span class="token string">'vscode.executeCompletionItemProvider'</span><span class="token punctuation">,</span>
    docUri<span class="token punctuation">,</span>
    position
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> vscode<span class="token punctuation">.</span>CompletionList<span class="token punctuation">;</span>

  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>actualCompletionList<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">,</span> expectedCompletionList<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  expectedCompletionList<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">expectedItem<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> actualItem <span class="token operator">=</span> actualCompletionList<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>actualItem<span class="token punctuation">.</span>label<span class="token punctuation">,</span> expectedItem<span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>actualItem<span class="token punctuation">.</span>kind<span class="token punctuation">,</span> expectedItem<span class="token punctuation">.</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In this test, we:</p> <ul><li>Activate the extension.</li> <li>Run the command <code>vscode.executeCompletionItemProvider</code> with a URI and a position to simulate completion trigger.</li> <li>Assert the returned completion items against our expected completion items.</li></ul> <p>Let's dive a bit deeper into the <code>activate(docURI)</code> function. It is defined in <code>client/src/test/helper.ts</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> doc<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>TextDocument<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> editor<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>TextEditor<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> documentEol<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> platformEol<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Activates the vscode.lsp-sample extension
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">docUri<span class="token punctuation">:</span> vscode<span class="token punctuation">.</span>Uri</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// The extensionId is `publisher.name` from package.json</span>
  <span class="token keyword">const</span> ext <span class="token operator">=</span> vscode<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'vscode.lsp-sample'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> ext<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    doc <span class="token operator">=</span> <span class="token keyword">await</span> vscode<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span><span class="token function">openTextDocument</span><span class="token punctuation">(</span>docUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    editor <span class="token operator">=</span> <span class="token keyword">await</span> vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showTextDocument</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for server activation</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the activation part, we:</p> <ul><li>Get the extension using the <code>{publisher.name}.{extensionId}</code>, as defined in <code>package.json</code>.</li> <li>Open the specified document, and show it in the active text editor.</li> <li>Sleep for 2 seconds, so we are sure the Language Server is instantiated.</li></ul> <p>After the preparation, we can run the <a href="/api/references/commands">VS Code Commands</a> corresponding to each language feature, and assert against the returned result.</p> <p>There is one more test that covers the diagnostics feature that we just implemented. Check it out at <code>client/src/test/diagnostics.test.ts</code>.</p> <h2 id="advanced-topics"><a href="#advanced-topics" aria-hidden="true" class="header-anchor">#</a> Advanced Topics</h2> <p>So far, this guide covered:</p> <ul><li>A brief overview of Language Server and Language Server Protocol.</li> <li>Architecture of a Language Server extension in VS Code</li> <li>The <strong>lsp-sample</strong> extension, and how to develop/debug/inspect/test it.</li></ul> <p>There are some more advanced topics we could not fit in to this guide. We will include links to these resources for further studying of Language Server development.</p> <h3 id="additional-language-server-features"><a href="#additional-language-server-features" aria-hidden="true" class="header-anchor">#</a> Additional Language Server features</h3> <p>The following language features are currently supported in a language server along with code completions:</p> <ul><li><em>Document Highlights</em>: highlights all 'equal' symbols in a text document.</li> <li><em>Hover</em>: provides hover information for a symbol selected in a text document.</li> <li><em>Signature Help</em>: provides signature help for a symbol selected in a text document.</li> <li><em>Goto Definition</em>: provides go to definition support for a symbol selected in a text document.</li> <li><em>Goto Type Definition</em>: provides go to type/interface definition support for a symbol selected in a text document.</li> <li><em>Goto Implementation</em>: provides go to implementation definition support for a symbol selected in a text document.</li> <li><em>Find References</em>: finds all project-wide references for a symbol selected in a text document.</li> <li><em>List Document Symbols</em>: lists all symbols defined in a text document.</li> <li><em>List Workspace Symbols</em>: lists all project-wide symbols.</li> <li><em>Code Actions</em>: compute commands to run (typically beautify/refactor) for a given text document and range.</li> <li><em>CodeLens</em>: compute CodeLens statistics for a given text document.</li> <li><em>Document Formatting</em>: this includes formatting of whole documents, document ranges and formatting on type.</li> <li><em>Rename</em>: project-wide rename of a symbol.</li> <li><em>Document Links</em>: compute and resolve links inside a document.</li> <li><em>Document Colors</em>: compute and resolve colors inside a document to provide color picker in editor.</li></ul> <p>The <a href="/api/language-extensions/programmatic-language-features">Programmatic Language Features</a> topic describes each of the language features above and provides guidance on how to implement them either through the language server protocol or by using the extensibility API directly from your extension.</p> <h3 id="incremental-text-document-synchronization"><a href="#incremental-text-document-synchronization" aria-hidden="true" class="header-anchor">#</a> Incremental Text Document Synchronization</h3> <p>The example uses the simple text document manager provided by the <code>vscode-languageserver</code> module to synchronize documents between VS Code and the language server.</p> <p>This has two drawbacks:</p> <ul><li>Lots of data transfer since the whole content of a text document is sent to the server repeatedly.</li> <li>If an existing language library is used, such libraries usually support incremental document updates to avoid unnecessary parsing and abstract syntax tree creation.</li></ul> <p>The protocol therefore supports incremental document synchronization as well.</p> <p>To make use of incremental document synchronization, a server needs to install three notification handlers:</p> <ul><li><em>onDidOpenTextDocument</em>: is called when a text document is opened in VS Code.</li> <li><em>onDidChangeTextDocument</em>: is called when the content of a text document changes in VS Code.</li> <li><em>onDidCloseTextDocument</em>: is called when a text document is closed in VS Code.</li></ul> <p>Below is a code snippet that illustrates how to hook these notification handlers on a connection and how to return the right capability on initialize:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>connection<span class="token punctuation">.</span><span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">InitializeResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        capabilities<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enable incremental document sync</span>
            textDocumentSync<span class="token punctuation">:</span> TextDocumentSyncKind<span class="token punctuation">.</span>Incremental<span class="token punctuation">,</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onDidOpenTextDocument</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// A text document was opened in VS Code.</span>
    <span class="token comment">// params.uri uniquely identifies the document. For documents stored on disk, this is a file URI.</span>
    <span class="token comment">// params.text the initial full content of the document.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onDidChangeTextDocument</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The content of a text document has change in VS Code.</span>
    <span class="token comment">// params.uri uniquely identifies the document.</span>
    <span class="token comment">// params.contentChanges describe the content changes to the document.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">onDidCloseTextDocument</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// A text document was closed in VS Code.</span>
    <span class="token comment">// params.uri uniquely identifies the document.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="using-vs-code-api-directly-to-implement-language-features"><a href="#using-vs-code-api-directly-to-implement-language-features" aria-hidden="true" class="header-anchor">#</a> Using VS Code API directly to implement Language Features</h3> <p>While Language Servers have many benefits, they are not the only option for extending the editing capabilities of VS Code. In the cases when you want to add some simple language features for a type of document, consider using <code>vscode.languages.register[LANGUAGE_FEATURE]Provider</code> as an option.</p> <p>Here is a <a href="https://github.com/Microsoft/vscode-extension-samples/tree/master/completions-sample" target="_blank" rel="noopener noreferrer"><code>completions-sample</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> using <code>vscode.languages.registerCompletionItemProvider</code> to add a few snippets as completions for plain text files.</p> <p>More samples illustrating the usage of VS Code API can be found at <a href="https://github.com/Microsoft/vscode-extension-samples" target="_blank" rel="noopener noreferrer">https://github.com/Microsoft/vscode-extension-samples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="error-tolerant-parser-for-language-server"><a href="#error-tolerant-parser-for-language-server" aria-hidden="true" class="header-anchor">#</a> Error Tolerant Parser for Language Server</h3> <p>Most of the time, the code in the editor is incomplete and syntactically incorrect, but developers would still expect autocomplete and other language features to work. Therefore, an error tolerant parser is necessary for a Language Server: The parser generates meaningful AST from partially complete code, and the Language Server provides language features based on the AST.</p> <p>When we were improving PHP support in VS Code, we realized the official PHP parser is not error tolerant and cannot be reused directly in the Language Server. Therefore, we worked on <a href="https://github.com/Microsoft/tolerant-php-parser" target="_blank" rel="noopener noreferrer">Microsoft/tolerant-php-parser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and left detailed <a href="https://github.com/Microsoft/tolerant-php-parser/blob/master/docs/HowItWorks.md" target="_blank" rel="noopener noreferrer">notes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that might help Language Server authors who need to implement an error tolerant parser.</p> <h2 id="common-questions"><a href="#common-questions" aria-hidden="true" class="header-anchor">#</a> Common questions</h2> <h3 id="when-i-try-to-attach-to-the-server-i-get-cannot-connect-to-runtime-process-timeout-after-5000-ms"><a href="#when-i-try-to-attach-to-the-server-i-get-cannot-connect-to-runtime-process-timeout-after-5000-ms" aria-hidden="true" class="header-anchor">#</a> When I try to attach to the server, I get &quot;cannot connect to runtime process (timeout after 5000 ms)&quot;?</h3> <p>You will see this timeout error if the server isn't running when you try to attach the debugger. The client starts the language server so make sure you have started the client in order to have a running server. You may also need to disable your client breakpoints if they are interfering with starting the server.</p> <h3 id="i-have-read-through-this-guide-and-the-lsp-specification-but-i-still-have-unresolved-questions-where-can-i-get-help"><a href="#i-have-read-through-this-guide-and-the-lsp-specification-but-i-still-have-unresolved-questions-where-can-i-get-help" aria-hidden="true" class="header-anchor">#</a> I have read through this guide and the <a href="https://microsoft.github.io/language-server-protocol/" target="_blank" rel="noopener noreferrer">LSP Specification<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, but I still have unresolved questions. Where can I get help?</h3> <p>Please open an issue at https://github.com/Microsoft/language-server-protocol.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vscode-doc-zh/assets/js/app.79cc50a5.js" defer></script><script src="/vscode-doc-zh/assets/js/2.6081b710.js" defer></script><script src="/vscode-doc-zh/assets/js/36.bb77a714.js" defer></script>
  </body>
</html>
